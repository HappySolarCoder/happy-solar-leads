<!DOCTYPE html>
<html>
<head>
    <title>Test Solar API</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #1a1a1a; color: #eee; max-width: 900px; margin: 0 auto; }
        button { padding: 12px 24px; background: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        pre { background: #222; color: #0f0; padding: 15px; border-radius: 5px; max-height: 500px; overflow: auto; white-space: pre-wrap; }
        .pass { color: #44ff44; }
        .fail { color: #ff4444; }
        .info { color: #66b3ff; }
    </style>
</head>
<body>
    <h1>☀️ Test Solar API</h1>
    <button onclick="testOneLead()">Test One Lead</button>
    <pre id="output"></pre>

    <script>
        function out(msg, type) {
            const el = document.getElementById('output');
            const color = type === 'pass' ? 'pass' : type === 'fail' ? 'fail' : type === 'info' ? 'info' : '';
            el.innerHTML += `<span class="${color}">${msg}</span>\n`;
        }

        async function testOneLead() {
            document.getElementById('output').innerHTML = '';
            out('Testing Solar API...\n');

            // Get first lead with coords
            const leads = JSON.parse(localStorage.getItem('happysolar_leads') || '[]');
            const lead = leads.find(l => l.lat && l.lng);

            if (!lead) {
                out('❌ No leads with coordinates found', 'fail');
                return;
            }

            out(`Lead: ${lead.name}`);
            out(`Coords: ${lead.lat}, ${lead.lng}\n`);

            // Test via proxy
            out('1. Testing via /api/solar proxy...', 'info');
            try {
                const response = await fetch('/api/solar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat: lead.lat, lng: lead.lng })
                });

                const data = await response.json();
                out(`Response status: ${response.status}`, response.ok ? 'pass' : 'fail');

                if (data.error) {
                    out(`Error: ${data.error}`, 'fail');
                    if (data.details) out(`Details: ${data.details}`, 'info');
                } else {
                    out('✅ Success!', 'pass');
                    out(JSON.stringify(data, null, 2));
                }
            } catch (e) {
                out(`Exception: ${e.message}`, 'fail');
            }

            // Also test direct
            out('\n2. Testing direct to Google...', 'info');
            const apiKey = 'AIzaSyCVbiweX65EncP7RyF6HZk0Y1_1ZosX_D8';
            const url = `https://solar.googleapis.com/v1/buildingInsights:getByLocation?location.latitude=${lead.lat}&location.longitude=${lead.lng}&key=${apiKey}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                out(`Direct response: ${response.status}`, response.ok ? 'pass' : 'fail');
                
                if (data.error) {
                    out(`Direct error: ${JSON.stringify(data.error)}`, 'fail');
                } else {
                    out('Direct works!', 'pass');
                }
            } catch (e) {
                out(`Direct exception: ${e.message}`, 'fail');
            }
        }
    </script>
</body>
</html>
